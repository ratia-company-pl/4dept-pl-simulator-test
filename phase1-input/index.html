<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1: 事業部入力システム</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .business-selector {
            padding: 12px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .business-selector:hover {
            border-color: #3498db;
            background: #f8fcff;
        }
        
        .business-selector.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 10px 16px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .preset-btn:hover {
            background: #229954;
            transform: translateY(-1px);
        }
        
        .export-btn {
            padding: 12px 24px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        .back-btn {
            background: #95a5a6;
        }
        
        .back-btn:hover {
            background: #7f8c8d;
        }
        
        .phase-btn {
            background: #3498db;
        }
        
        .phase-btn:hover {
            background: #2980b9;
        }
        
        .phase4-btn {
            background: #8e44ad;
        }
        
        .phase4-btn:hover {
            background: #7d3c98;
        }
        
        .input-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .input-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .input-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .input-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .metric-label {
            text-align: left !important;
            font-weight: 600;
            color: #2c3e50;
            background: #f8f9fa;
            padding-left: 20px !important;
        }
        
        .input-field {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .current-business {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
        }
        
        .progress-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .completion-status {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .status-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-complete {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .status-incomplete {
            background: #ffeaa7;
            color: #fdcb6e;
        }
        
        .test-section {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-title {
            color: #27ae60;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .test-instructions {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .test-data {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #27ae60;
            font-family: monospace;
            font-size: 14px;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Phase 1: 事業部入力システム</h1>
        
        <div class="test-section">
            <div class="test-title">GitHub Pages Phase 4連携テスト</div>
            <div class="test-instructions">
                1. 「テストデータ入力」でサンプルデータ設定<br>
                2. 「Phase 2で基本PL確認」→従来の基本計算<br>
                3. 「Phase 4で詳細PL確認」→修正版詳細計算<br>
                4. GitHub Pages環境での自動連携確認
            </div>
            <div class="test-data">
                【SR事業部 1月】売上:2000 原価:600 人件費:400 広告費:50<br>
                【W事業部 1月】売上:1000 原価:300 人件費:200 広告費:30
            </div>
        </div>
        
        <div class="progress-info">
            <strong>GitHub Pages テスト版:</strong> Phase 4詳細PL機能連携対応
        </div>
        
        <div class="controls">
            <button class="export-btn back-btn" onclick="window.location.href='../'">← メニューに戻る</button>
            
            <button class="business-selector active" data-business="sr">SR事業部</button>
            <button class="business-selector" data-business="w">W事業部</button>
            <button class="business-selector" data-business="rc">RC社事業部</button>
            <button class="business-selector" data-business="rcd">RCD社事業部</button>
            
            <div class="preset-buttons">
                <button class="preset-btn" onclick="applyPreset('growth')">成長シナリオ</button>
                <button class="preset-btn" onclick="applyPreset('stable')">安定シナリオ</button>
                <button class="preset-btn" onclick="applyPreset('decline')">減収シナリオ</button>
                <button class="preset-btn" onclick="applyPreset('clear')">クリア</button>
                <button class="preset-btn" onclick="applyTestData()" style="background: #27ae60;">テストデータ入力</button>
            </div>
        </div>
        
        <div class="button-row">
            <button class="export-btn" onclick="exportForAnalysis()">Excel分析用エクスポート</button>
            <button class="export-btn phase-btn" onclick="transferToPhase2()">Phase 2で基本PL確認 →</button>
            <button class="export-btn phase4-btn" onclick="transferToPhase4()">Phase 4で詳細PL確認 →</button>
        </div>
        
        <div class="current-business" id="currentBusiness">SR事業部 - データ入力</div>
        
        <div class="completion-status">
            <div class="status-item status-incomplete" id="status-sr">SR事業部: 未入力</div>
            <div class="status-item status-incomplete" id="status-w">W事業部: 未入力</div>
            <div class="status-item status-incomplete" id="status-rc">RC社事業部: 未入力</div>
            <div class="status-item status-incomplete" id="status-rcd">RCD社事業部: 未入力</div>
        </div>
        
        <table class="input-table">
            <thead>
                <tr>
                    <th style="width: 200px;">項目</th>
                    <th>1月</th>
                    <th>2月</th>
                    <th>3月</th>
                    <th>4月</th>
                    <th>5月</th>
                    <th>6月</th>
                    <th>7月</th>
                    <th>8月</th>
                    <th>9月</th>
                    <th>10月</th>
                    <th>11月</th>
                    <th>12月</th>
                </tr>
            </thead>
            <tbody id="inputTableBody">
            </tbody>
        </table>
    </div>

    <script>
        // データ構造
        const businessData = {
            sr: {
                plConfig: {
                    grossMarginRate: 0.272,
                    commissionRate: 0.035,
                    advertising: { 1: 0, 2: 2, 3: 0, 4: 0, 5: 0, 6: 6, 7: 0, 8: 6, 9: 0, 10: 10, 11: 0, 12: 12 },
                    fixedCosts: { venue: 154, facility: 86, others: 84 }
                }
            },
            w: {
                plConfig: {
                    grossMarginRate: 0.2996,
                    paymentFeeThreshold: 1000,
                    paymentFeeRates: { low: 0.06, high: 0.08 },
                    personnelRanges: [
                        { min: 0, max: 500, cost: 120 },
                        { min: 500, max: 1000, cost: 150 },
                        { min: 1000, max: 1500, cost: 180 },
                        { min: 1500, max: Infinity, cost: 200 }
                    ],
                    bonusMonths: { 8: 1.0, 12: 1.5 }
                }
            },
            rc: {
                plConfig: {
                    grossMarginRate: 0.352,
                    fixedPersonnel: 280,
                    fixedCosts: { venue: 154, facility: 86, others: 84 }
                }
            },
            rcd: {
                plConfig: {
                    grossMarginRate: 0.97,
                    fixedCosts: { managementFees: 90.6 }
                }
            }
        };

        let currentBusiness = 'sr';
        let inputData = {};

        // 初期化
        function init() {
            Object.keys(businessData).forEach(business => {
                inputData[business] = {};
                for (let month = 1; month <= 12; month++) {
                    inputData[business][month] = {
                        revenue: 0,
                        costs: 0,
                        personnel: 0,
                        advertising: 0
                    };
                }
            });
            
            renderTable();
            updateBusinessSelector();
        }

        // テストデータ適用
        function applyTestData() {
            inputData.sr[1] = { revenue: 2000, costs: 600, personnel: 400, advertising: 50 };
            inputData.w[1] = { revenue: 1000, costs: 300, personnel: 200, advertising: 30 };
            
            renderTable();
            updateCompletionStatus();
            alert('テストデータを入力しました！SR・W事業部の1月データが設定されています。');
        }

        // テーブル描画
        function renderTable() {
            const tbody = document.getElementById('inputTableBody');
            const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: '売上高 (万円)', field: 'revenue' },
                { label: '原価 (万円)', field: 'costs' },
                { label: '人件費 (万円)', field: 'personnel' },
                { label: '広告費 (万円)', field: 'advertising' }
            ];

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="metric-label">${row.label}</td>
                    ${months.map((_, index) => `
                        <td>
                            <input type="number" class="input-field" 
                                   value="${inputData[currentBusiness][index + 1][row.field]}"
                                   onchange="updateData(${index + 1}, '${row.field}', this.value)">
                        </td>
                    `).join('')}
                `;
                tbody.appendChild(tr);
            });
        }

        // データ更新
        function updateData(month, field, value) {
            inputData[currentBusiness][month][field] = parseFloat(value) || 0;
            updateCompletionStatus();
        }

        // 事業部選択
        function updateBusinessSelector() {
            const selectors = document.querySelectorAll('.business-selector');
            selectors.forEach(selector => {
                selector.addEventListener('click', function() {
                    selectors.forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    currentBusiness = this.dataset.business;
                    
                    const businessNames = {
                        sr: 'SR事業部', w: 'W事業部', 
                        rc: 'RC社事業部', rcd: 'RCD社事業部'
                    };
                    
                    document.getElementById('currentBusiness').textContent = 
                        businessNames[currentBusiness] + ' - データ入力';
                    
                    renderTable();
                });
            });
        }

        // プリセット適用
        function applyPreset(preset) {
            const baseRevenue = { sr: 2000, w: 1000, rc: 1550, rcd: 2000 }[currentBusiness] || 1000;
            
            for (let month = 1; month <= 12; month++) {
                switch(preset) {
                    case 'growth':
                        inputData[currentBusiness][month].revenue = Math.floor(baseRevenue * (1 + month * 0.05));
                        inputData[currentBusiness][month].costs = Math.floor(inputData[currentBusiness][month].revenue * 0.3);
                        inputData[currentBusiness][month].personnel = 150 + month * 10;
                        inputData[currentBusiness][month].advertising = month % 3 === 0 ? 50 : 20;
                        break;
                    case 'stable':
                        inputData[currentBusiness][month].revenue = baseRevenue;
                        inputData[currentBusiness][month].costs = Math.floor(baseRevenue * 0.35);
                        inputData[currentBusiness][month].personnel = 150;
                        inputData[currentBusiness][month].advertising = 25;
                        break;
                    case 'decline':
                        inputData[currentBusiness][month].revenue = Math.floor(baseRevenue * (1 - month * 0.03));
                        inputData[currentBusiness][month].costs = Math.floor(inputData[currentBusiness][month].revenue * 0.4);
                        inputData[currentBusiness][month].personnel = 200 - month * 5;
                        inputData[currentBusiness][month].advertising = 15;
                        break;
                    case 'clear':
                        Object.keys(inputData[currentBusiness][month]).forEach(key => {
                            inputData[currentBusiness][month][key] = 0;
                        });
                        break;
                }
            }
            renderTable();
            updateCompletionStatus();
        }

        // 完了状況更新
        function updateCompletionStatus() {
            Object.keys(inputData).forEach(business => {
                const hasData = Object.values(inputData[business]).some(monthData => 
                    Object.values(monthData).some(value => value > 0)
                );
                
                const statusElement = document.getElementById(`status-${business}`);
                if (hasData) {
                    statusElement.className = 'status-item status-complete';
                    statusElement.textContent = statusElement.textContent.replace('未入力', '完了');
                } else {
                    statusElement.className = 'status-item status-incomplete';
                    statusElement.textContent = statusElement.textContent.replace('完了', '未入力');
                }
            });
        }

        // Excel分析用エクスポート
        function exportForAnalysis() {
            let csv = 'Business,Month,Revenue,Costs,Personnel,Advertising\n';
            
            Object.keys(inputData).forEach(business => {
                const businessName = { sr: 'SR事業部', w: 'W事業部', rc: 'RC社事業部', rcd: 'RCD社事業部' }[business];
                
                for (let month = 1; month <= 12; month++) {
                    const data = inputData[business][month];
                    csv += `${businessName},${month}月,${data.revenue},${data.costs},${data.personnel},${data.advertising}\n`;
                }
            });
            
            const dataBlob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `business_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('Excel分析用CSVファイルをエクスポートしました！');
        }

        // Phase 2への自動データ転送
        function transferToPhase2() {
            const hasData = Object.keys(inputData).some(business =>
                Object.values(inputData[business]).some(monthData =>
                    Object.values(monthData).some(value => value > 0)
                )
            );
            
            if (!hasData) {
                alert('データが入力されていません。「テストデータ入力」ボタンでサンプルデータを入力してください。');
                return;
            }
            
            const transferData = {
                timestamp: new Date().toISOString(),
                businessData: inputData,
                configs: businessData
            };
            
            localStorage.setItem('phase1_to_phase2_data', JSON.stringify(transferData));
            window.location.href = '../phase2-pl-display/?from=phase1';
        }

        // Phase 4への自動データ転送
        function transferToPhase4() {
            const hasData = Object.keys(inputData).some(business =>
                Object.values(inputData[business]).some(monthData =>
                    Object.values(monthData).some(value => value > 0)
                )
            );
            
            if (!hasData) {
                alert('データが入力されていません。「テストデータ入力」ボタンでサンプルデータを入力してください。');
                return;
            }
            
            const transferData = {
                timestamp: new Date().toISOString(),
                businessData: inputData,
                configs: businessData,
                version: 'Phase4_DetailedPL'
            };
            
            localStorage.setItem('phase1_to_phase2_data', JSON.stringify(transferData));
            window.location.href = '../phase4-detailed-pl/?from=phase1';
            
            alert('Phase 4: 詳細PL表示システムでデータを確認してください！修正版計算ロジックが適用されます。');
        }

        // 初期化実行
        init();
    </script>
</body>
</html>
