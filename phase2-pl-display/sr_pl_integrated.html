<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SR事業部詳細PL - 連携対応版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            border-radius: 12px;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .linkage-status {
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .linkage-status.error {
            background: #fef2f2;
            border-color: #e53e3e;
        }
        
        .linkage-status.warning {
            background: #fffcf0;
            border-color: #f6ad55;
        }
        
        .nav-links {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .nav-link {
            color: #3182ce;
            text-decoration: none;
            font-weight: 600;
            margin: 0 15px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: #3182ce;
            color: white;
        }
        
        .input-section {
            background: #fffbf0;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #744210;
            margin-bottom: 5px;
        }
        
        .input-group input {
            padding: 8px;
            border: 1px solid #d2d6dc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(229, 62, 62, 0.3);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .pl-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .pl-table th,
        .pl-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
        }
        
        .pl-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .revenue-row {
            background: #f0fff4;
            font-weight: 600;
        }
        
        .gross-profit-row {
            background: #fffbeb;
            font-weight: 600;
        }
        
        .expense-total-row {
            background: #f3f4f6;
            font-weight: 600;
        }
        
        .operating-profit-row {
            font-weight: 600;
        }
        
        .variable-item {
            background: #fef5e7;
        }
        
        .personnel-highlight {
            background: #f0f9ff;
        }
        
        .special-month {
            color: #dc2626;
            font-weight: 600;
        }
        
        .profit-positive {
            background: #f0fff4;
            color: #16a34a;
        }
        
        .profit-negative {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-btn.actual { background: #48bb78; color: white; }
        .preset-btn.scenario { background: #4299e1; color: white; }
        .preset-btn.linkage { background: #f6ad55; color: white; }
        
        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.green {
            background: #48bb78;
            color: white;
        }

        .action-btn.blue {
            background: #4299e1;
            color: white;
        }

        .action-btn.orange {
            background: #f6ad55;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SR事業部 詳細PL表示システム</h1>
            <p>連携対応版 - Option A入力系からのデータ自動取得対応</p>
        </div>
        
        <div id="linkage-status" class="linkage-status">
            <strong>連携状態:</strong> <span id="status-text">確認中...</span>
        </div>
        
        <div class="nav-links">
            <a href="../index.html" class="nav-link">メインメニュー</a>
            <a href="../pl_simulator_option_a.html" class="nav-link">Option A入力系</a>
            <a href="sr_detailed_pl.html" class="nav-link">単独版PL</a>
            <a href="../phase3-dashboard/" class="nav-link">統合ダッシュボード</a>
        </div>
        
        <div class="input-section">
            <h3 style="margin-bottom: 15px; color: #744210;">売上・設定パラメータ</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label>月次売上合計（万円）</label>
                    <input type="text" id="monthly-sales" readonly>
                </div>
                <div class="input-group">
                    <label>営業コミッション（万円）</label>
                    <input type="number" id="commission" value="100" onchange="updateCalculation()">
                </div>
                <div class="input-group">
                    <label>6月賞与（万円）</label>
                    <input type="number" id="bonus6" value="100" onchange="updateCalculation()">
                </div>
                <div class="input-group">
                    <label>12月賞与（万円）</label>
                    <input type="number" id="bonus12" value="0" onchange="updateCalculation()">
                </div>
                <div class="input-group">
                    <label>広告宣伝費（万円/月）</label>
                    <input type="number" id="advertising" value="30" onchange="updateCalculation()">
                </div>
            </div>
        </div>
        
        <div class="preset-buttons">
            <button class="preset-btn linkage" onclick="loadLinkageData()">連携データ再読み込み</button>
            <button class="preset-btn actual" onclick="applyPreset('actual')">実績値パターン</button>
            <button class="preset-btn scenario" onclick="applyPreset('optimistic')">楽観シナリオ（+20%）</button>
            <button class="preset-btn scenario" onclick="applyPreset('conservative')">保守シナリオ（-10%）</button>
            <button class="preset-btn scenario" onclick="applyPreset('growth')">成長シナリオ（+30%）</button>
        </div>
        
        <div class="summary-cards" id="summary-cards">
            <!-- サマリーカードがここに生成される -->
        </div>
        
        <div style="overflow-x: auto;">
            <table class="pl-table" id="pl-table">
                <!-- PL表がここに生成される -->
            </table>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn green" onclick="exportData()">データエクスポート</button>
            <button class="action-btn blue" onclick="sendToDashboard()">ダッシュボードに送信</button>
            <button class="action-btn orange" onclick="openInputSystem()">入力システムを開く</button>
        </div>
    </div>

    <script>
        // 基本データ
        const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
        
        // 売上データ（連携データまたはデフォルト値）
        let monthlySales = [2236, 2917, 2927, 2810, 2544, 2664, 3008, 2325, 2403, 2603, 2229, 2722];
        let isLinkageData = false;
        
        // PLデータ（sr_detailed_pl.htmlから移植）
        const srPLData = {
            salesRanges: [
                { min: 2100, max: 2399, rate: 33.8 },
                { min: 2400, max: 2699, rate: 29.8 },
                { min: 2700, max: 2999, rate: 29.8 },
                { min: 3000, max: 3299, rate: 24.5 }
            ],
            coefficients: {
                fees: [0.71, 1.45, 0.92, 0.90, 1.51, 0.90, 1.20, 0.79, 0.70, 1.12, 0.80, 1.00],
                freightPacking: [1.76, 0.13, 1.82, 0.93, 0.08, 0.96, 1.78, 0.93, 0.97, 0.92, 0.07, 1.65],
                utilities: [0.84, 0.97, 1.41, 1.13, 0.86, 0.84, 0.90, 1.17, 1.17, 1.07, 0.82, 0.82]
            },
            annualExpenses: {
                hygiene: 166,
                logistics: 2500,
                rent: 2574,
                outsourcing: 1470,
                freightPacking: 851,
                travel: 374,
                communication: 227,
                promotion: 468,
                supplies: 43,
                office: 127,
                utilities: 579,
                fees: 1057,
                lease: 14,
                insurance: 67,
                consulting: 408,
                depreciation: 230
            }
        };

        // 設定変数
        let settings = {
            commission: 100,
            bonus6: 100,
            bonus12: 0,
            advertising: 30
        };

        // 連携データ読み込み（拡張版）
        function loadLinkageData() {
            const srSalesData = localStorage.getItem('sr_sales_data');
            const srSettings = localStorage.getItem('sr_pl_settings');
            
            let dataLoaded = false;
            let settingsLoaded = false;
            
            if (srSalesData) {
                try {
                    const salesData = JSON.parse(srSalesData);
                    if (salesData.monthlySales && Array.isArray(salesData.monthlySales)) {
                        monthlySales = salesData.monthlySales;
                        isLinkageData = true;
                        dataLoaded = true;
                        console.log('売上データ読み込み成功:', salesData);
                    }
                } catch (e) {
                    console.error('売上データ読み込みエラー:', e);
                }
            }
            
            if (srSettings) {
                try {
                    const settingsData = JSON.parse(srSettings);
                    if (settingsData) {
                        settings = { ...settings, ...settingsData };
                        settingsLoaded = true;
                        // 設定値をUIに反映
                        document.getElementById('commission').value = settings.commission || 100;
                        document.getElementById('bonus6').value = settings.bonus6 || 100;
                        document.getElementById('bonus12').value = settings.bonus12 || 0;
                        document.getElementById('advertising').value = settings.advertising || 30;
                        console.log('設定データ読み込み成功:', settingsData);
                    }
                } catch (e) {
                    console.error('設定データ読み込みエラー:', e);
                }
            }
            
            // 状態表示更新
            if (dataLoaded && settingsLoaded) {
                updateLinkageStatus('success', '✅ Option A入力系からデータを正常に取得しました（売上データ + 設定データ）');
            } else if (dataLoaded) {
                updateLinkageStatus('success', '✅ Option A入力系から売上データを正常に取得しました');
            } else if (settingsLoaded) {
                updateLinkageStatus('warning', '⚠️ 設定データのみ取得。売上データが見つかりません');
            } else {
                updateLinkageStatus('error', '❌ 連携データが見つかりません。Option A入力系からデータを送信してください');
            }
            
            updateDisplay();
            return dataLoaded || settingsLoaded;
        }

        // 連携状態更新
        function updateLinkageStatus(status, message) {
            const statusDiv = document.getElementById('linkage-status');
            const statusText = document.getElementById('status-text');
            
            statusDiv.className = `linkage-status ${status}`;
            statusText.textContent = message;
        }

        // 数値フォーマット
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // 人件費係数取得
        function getPersonnelRate(salesAmount) {
            for (const range of srPLData.salesRanges) {
                if (salesAmount >= range.min && salesAmount <= range.max) {
                    return range.rate;
                }
            }
            if (salesAmount < 2100) return 33.8;
            if (salesAmount > 3299) return 24.5;
            return 30.4;
        }

        // 人件費計算
        function calculatePersonnel(monthIndex, salesAmount) {
            const rate = getPersonnelRate(salesAmount);
            const basePersonnel = salesAmount * (rate / 100);
            
            let specialAmount = 0;
            // 営業コミッション（6月・10月・2月）
            if (monthIndex === 11 || monthIndex === 3 || monthIndex === 7) {
                specialAmount += settings.commission;
            }
            // 6月賞与
            if (monthIndex === 11) {
                specialAmount += settings.bonus6;
            }
            // 12月賞与
            if (monthIndex === 5) {
                specialAmount += settings.bonus12;
            }
            
            return Math.round(basePersonnel + specialAmount);
        }

        // 月次PL計算
        function calculateMonthlyPL(monthIndex, salesAmount) {
            const cogs = salesAmount * 0.272;
            const grossProfit = salesAmount - cogs;
            
            const personnel = calculatePersonnel(monthIndex, salesAmount);
            const welfare = Math.round(personnel * 0.1284);
            const hygiene = Math.round(srPLData.annualExpenses.hygiene / 12);
            const logistics = Math.round(srPLData.annualExpenses.logistics / 12);
            const rent = Math.round(srPLData.annualExpenses.rent / 12);
            const outsourcing = Math.round(srPLData.annualExpenses.outsourcing / 12);
            const freightPacking = Math.round(srPLData.annualExpenses.freightPacking / 12 * srPLData.coefficients.freightPacking[monthIndex]);
            const advertisingCost = settings.advertising;
            const travel = Math.round(srPLData.annualExpenses.travel / 12);
            const communication = Math.round(srPLData.annualExpenses.communication / 12);
            const promotion = Math.round(srPLData.annualExpenses.promotion / 12);
            const supplies = Math.round(srPLData.annualExpenses.supplies / 12);
            const office = Math.round(srPLData.annualExpenses.office / 12);
            const utilities = Math.round(srPLData.annualExpenses.utilities / 12 * srPLData.coefficients.utilities[monthIndex]);
            const fees = Math.round(srPLData.annualExpenses.fees / 12 * srPLData.coefficients.fees[monthIndex]);
            const lease = Math.round(srPLData.annualExpenses.lease / 12);
            const insurance = Math.round(srPLData.annualExpenses.insurance / 12);
            const consulting = Math.round(srPLData.annualExpenses.consulting / 12);
            const depreciation = Math.round(srPLData.annualExpenses.depreciation / 12);
            
            const totalExpenses = personnel + welfare + hygiene + logistics + rent + outsourcing + 
                                 freightPacking + advertisingCost + travel + communication + promotion + 
                                 supplies + office + utilities + fees + lease + insurance + consulting + depreciation;
            
            const operatingProfit = grossProfit - totalExpenses;
            
            return {
                sales: salesAmount,
                cogs: Math.round(cogs),
                grossProfit: Math.round(grossProfit),
                personnel,
                welfare,
                hygiene,
                logistics,
                rent,
                outsourcing,
                freightPacking,
                advertising: advertisingCost,
                travel,
                communication,
                promotion,
                supplies,
                office,
                utilities,
                fees,
                lease,
                insurance,
                consulting,
                depreciation,
                totalExpenses,
                operatingProfit: Math.round(operatingProfit)
            };
        }

        // PL更新
        function updateCalculation() {
            // 設定値を更新
            settings.commission = parseInt(document.getElementById('commission').value) || 0;
            settings.bonus6 = parseInt(document.getElementById('bonus6').value) || 0;
            settings.bonus12 = parseInt(document.getElementById('bonus12').value) || 0;
            settings.advertising = parseInt(document.getElementById('advertising').value) || 0;

            updateDisplay();
        }

        // 表示更新
        function updateDisplay() {
            // PL計算
            const monthlyPL = monthlySales.map((sales, i) => calculateMonthlyPL(i, sales));
            const annual = {
                sales: monthlyPL.reduce((sum, m) => sum + m.sales, 0),
                cogs: monthlyPL.reduce((sum, m) => sum + m.cogs, 0),
                grossProfit: monthlyPL.reduce((sum, m) => sum + m.grossProfit, 0),
                totalExpenses: monthlyPL.reduce((sum, m) => sum + m.totalExpenses, 0),
                operatingProfit: monthlyPL.reduce((sum, m) => sum + m.operatingProfit, 0)
            };

            // 売上データ表示更新
            document.getElementById('monthly-sales').value = monthlySales.map(s => formatNumber(s)).join(', ');

            // サマリー更新
            updateSummary(annual);
            
            // PL表更新
            updatePLTable(monthlyPL, annual);
        }

        // サマリー更新
        function updateSummary(annual) {
            const summaryCards = document.getElementById('summary-cards');
            const margin = ((annual.operatingProfit / annual.sales) * 100).toFixed(1);
            
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${formatNumber(annual.sales)}万円</div>
                    <div class="summary-label">年間売上高（A）</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${formatNumber(annual.grossProfit)}万円</div>
                    <div class="summary-label">売上総利益（C）</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${formatNumber(annual.operatingProfit)}万円</div>
                    <div class="summary-label">営業利益（E）</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${margin}%</div>
                    <div class="summary-label">営業利益率</div>
                </div>
            `;
        }

        // PL表更新（sr_detailed_pl.htmlから移植）
        function updatePLTable(monthlyPL, annual) {
            const table = document.getElementById('pl-table');
            let html = `
                <thead>
                    <tr>
                        <th style="width: 40px;">ID</th>
                        <th style="width: 120px;">科目</th>
                        ${months.map(month => `<th>${month}</th>`).join('')}
                        <th style="background: #ebf8ff;">年間合計</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // 売上高
            html += `
                <tr class="revenue-row">
                    <td>A</td>
                    <td>売上高_SR</td>
                    ${monthlyPL.map(pl => `<td>${formatNumber(pl.sales)}</td>`).join('')}
                    <td style="background: #f0fff4; font-weight: 700;">${formatNumber(annual.sales)}</td>
                </tr>
            `;

            // 仕入_SR
            html += `
                <tr>
                    <td>B</td>
                    <td>仕入_SR（27.2%）</td>
                    ${monthlyPL.map(pl => `<td>${formatNumber(pl.cogs)}</td>`).join('')}
                    <td>${formatNumber(annual.cogs)}</td>
                </tr>
            `;

            // 売上総利益
            html += `
                <tr class="gross-profit-row">
                    <td>C</td>
                    <td>売上総利益</td>
                    ${monthlyPL.map(pl => `<td>${formatNumber(pl.grossProfit)}</td>`).join('')}
                    <td style="background: #fffbeb; font-weight: 700;">${formatNumber(annual.grossProfit)}</td>
                </tr>
            `;

            // 販管費項目
            const items = [
                {id: '1', name: '人件費統合', key: 'personnel', highlight: true},
                {id: '2', name: '法定福利費', key: 'welfare'},
                {id: '3', name: '衛生費', key: 'hygiene'},
                {id: '4', name: '物流管理費', key: 'logistics'},
                {id: '5', name: '地代家賃', key: 'rent'},
                {id: '6', name: '外注費', key: 'outsourcing'},
                {id: '7', name: '運送運賃（変動）', key: 'freightPacking', variable: true},
                {id: '8', name: '広告宣伝費', key: 'advertising'},
                {id: '9', name: '旅費交通費', key: 'travel'},
                {id: '10', name: '通信費', key: 'communication'},
                {id: '11', name: '販売促進費', key: 'promotion'},
                {id: '12', name: '消耗品費', key: 'supplies'},
                {id: '13', name: '事務用品費', key: 'office'},
                {id: '14', name: '水道光熱費（変動）', key: 'utilities', variable: true},
                {id: '15', name: '支払手数料（変動）', key: 'fees', variable: true},
                {id: '16', name: 'リース料', key: 'lease'},
                {id: '17', name: '保険料', key: 'insurance'},
                {id: '18', name: '支払報酬料', key: 'consulting'},
                {id: '19', name: '減価償却費', key: 'depreciation'}
            ];

            items.forEach(item => {
                const bgClass = item.variable ? 'variable-item' : (item.highlight ? 'personnel-highlight' : '');
                html += `
                    <tr class="${bgClass}">
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        ${monthlyPL.map((pl, i) => {
                            const value = pl[item.key];
                            const isSpecialMonth = item.key === 'personnel' && (i === 11 || i === 3 || i === 7 || i === 5);
                            const style = isSpecialMonth ? 'special-month' : '';
                            return `<td class="${style}">${formatNumber(value)}</td>`;
                        }).join('')}
                        <td>${formatNumber(monthlyPL.reduce((sum, m) => sum + m[item.key], 0))}</td>
                    </tr>
                `;
            });

            // 販売管理費 計
            html += `
                <tr class="expense-total-row">
                    <td>D</td>
                    <td>販売管理費 計</td>
                    ${monthlyPL.map(pl => `<td>${formatNumber(pl.totalExpenses)}</td>`).join('')}
                    <td style="background: #f3f4f6; font-weight: 700;">${formatNumber(annual.totalExpenses)}</td>
                </tr>
            `;

            // 営業利益
            const profitClass = annual.operatingProfit >= 0 ? 'profit-positive' : 'profit-negative';
            html += `
                <tr class="operating-profit-row ${profitClass}">
                    <td>E</td>
                    <td>営業利益</td>
                    ${monthlyPL.map(pl => {
                        const className = pl.operatingProfit >= 0 ? 'profit-positive' : 'profit-negative';
                        return `<td class="${className}">${formatNumber(pl.operatingProfit)}</td>`;
                    }).join('')}
                    <td style="font-weight: 700;">${formatNumber(annual.operatingProfit)}</td>
                </tr>
            `;

            html += '</tbody>';
            table.innerHTML = html;
        }

        // プリセット適用
        function applyPreset(type) {
            const baseSales = [2236, 2917, 2927, 2810, 2544, 2664, 3008, 2325, 2403, 2603, 2229, 2722];
            
            switch(type) {
                case 'actual':
                    monthlySales = [...baseSales];
                    isLinkageData = false;
                    break;
                case 'optimistic':
                    monthlySales = baseSales.map(s => Math.round(s * 1.2));
                    isLinkageData = false;
                    break;
                case 'conservative':
                    monthlySales = baseSales.map(s => Math.round(s * 0.9));
                    isLinkageData = false;
                    break;
                case 'growth':
                    monthlySales = baseSales.map(s => Math.round(s * 1.3));
                    isLinkageData = false;
                    break;
            }
            
            updateDisplay();
        }

        // データエクスポート
        function exportData() {
            const monthlyPL = monthlySales.map((sales, i) => calculateMonthlyPL(i, sales));
            const annual = {
                sales: monthlyPL.reduce((sum, m) => sum + m.sales, 0),
                grossProfit: monthlyPL.reduce((sum, m) => sum + m.grossProfit, 0),
                totalExpenses: monthlyPL.reduce((sum, m) => sum + m.totalExpenses, 0),
                operatingProfit: monthlyPL.reduce((sum, m) => sum + m.operatingProfit, 0)
            };

            const exportData = {
                timestamp: new Date().toISOString(),
                isLinkageData,
                settings,
                monthlySales,
                monthlyPL,
                annual
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sr_detailed_pl_linkage_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ダッシュボードに送信
        function sendToDashboard() {
            const monthlyPL = monthlySales.map((sales, i) => calculateMonthlyPL(i, sales));
            const annual = {
                sales: monthlyPL.reduce((sum, m) => sum + m.sales, 0),
                grossProfit: monthlyPL.reduce((sum, m) => sum + m.grossProfit, 0),
                totalExpenses: monthlyPL.reduce((sum, m) => sum + m.totalExpenses, 0),
                operatingProfit: monthlyPL.reduce((sum, m) => sum + m.operatingProfit, 0)
            };

            // ダッシュボード用データ保存
            localStorage.setItem('sr_pl_results', JSON.stringify({
                department: 'SR',
                annual,
                monthlyPL,
                settings,
                timestamp: new Date().toISOString()
            }));

            // ダッシュボードを開く
            window.open('../phase3-dashboard/', '_blank');
            alert('SR事業部PL結果をダッシュボードに送信しました');
        }

        // 入力システムを開く
        function openInputSystem() {
            window.open('../pl_simulator_option_a.html', '_blank');
        }

        // 初期化
        window.onload = function() {
            // 連携データ読み込み試行
            const linkageSuccess = loadLinkageData();
            
            if (!linkageSuccess) {
                // 連携データがない場合はデフォルト状態で初期化
                updateLinkageStatus('warning', '⚠️ 連携データなし - デフォルト値で表示中');
                updateDisplay();
            }
        };
    </script>
</body>
</html>